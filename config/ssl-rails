<IfModule mod_ssl.c>
NameVirtualHost *:443

# Strengthen the SSL protocol to current recommendations.
SSLProtocol all -SSLv2
SSLCipherSuite HIGH:MEDIUM:!aNULL:+SHA1:+MD5:+HIGH:+MEDIUM
SSLOptions +StrictRequire

#Stealth mode
ServerSignature Off

<VirtualHost *:443>

  #Switch on SSL and select certificate
  SSLEngine On
  SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

  #Activate the SSL bit-bucket.
  <Location />
      SSLRequireSSL
      Order allow,deny
      Deny from all
  </Location>

  CustomLog /var/log/apache2/ssl_request_log \
      "%t %h %{HTTPS}x %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{SSL_CIPHER_USEKEYSIZE}x %{SSL_CLIENT_VERIFY}x \"%r\" %b" 

</VirtualHost>

<VirtualHost *:443>
  #Switch on SSL and select certificate
  SSLEngine On
  SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

  # Capture our domain(s)
  ServerName 3accounts.co.uk
  ServerAlias *.3accounts.co.uk
  
  # Make sure that Rails knows this request came via https
  RequestHeader set X_FORWARDED_PROTO 'https'

  DocumentRoot /home/rails/3accounts/current/public

  <Directory "/home/rails/3accounts/current/public">
    SSLRequireSSL
    Options FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
  </Directory>

  # Configure mongrel_cluster
  <Proxy balancer://mongrel_cluster>
    SSLRequireSSL
    BalancerMember http://127.0.0.1:9200
    BalancerMember http://127.0.0.1:9201
  </Proxy>

  ErrorLog /var/log/apache2/3accounts_error_log
  CustomLog /var/log/apache2/3accounts_log combined

  CustomLog /var/log/apache2/ssl_request_log \
      "%t %h %{HTTPS}x %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{SSL_CIPHER_USEKEYSIZE}x %{SSL_CLIENT_VERIFY}x \"%r\" %b" 

  # Rails specific rewrite rules
  Include /etc/apache2/brightbox-common
</VirtualHost>

</IfModule>
